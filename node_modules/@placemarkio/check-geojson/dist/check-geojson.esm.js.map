{"version":3,"file":"check-geojson.esm.js","sources":["../src/errors.ts","../src/types.ts","../src/get_type.ts","../src/get_member_value.ts","../src/get_array.ts","../src/get_object.ts","../src/get_coordinates.ts","../src/array_is_numbers.ts","../src/enforce_position.ts","../src/check_duplicate_keys.ts","../src/enforce_same_position.ts","../src/enforce_position_array.ts","../src/enforce_bbox.ts","../src/forbid_confusing_properties.ts","../src/index.ts"],"sourcesContent":["import { Node } from '@humanwhocodes/momoa';\n\nexport interface HintIssue {\n  from: number;\n  to: number;\n  severity: 'error';\n  message: string;\n}\n\nexport function makeIssue(message: string, node: Node): HintIssue {\n  return {\n    message,\n    severity: 'error',\n    from: node.loc.start.offset,\n    to: node.loc.end.offset,\n  };\n}\n\nexport class HintError extends Error {\n  issues: HintIssue[] = [];\n\n  constructor(issues: HintIssue[]) {\n    super();\n    // restore prototype chain\n    const actualProto = new.target.prototype;\n    Object.setPrototypeOf(this, actualProto);\n    this.issues = issues;\n  }\n\n  get message() {\n    return JSON.stringify(this.issues, null, 2);\n  }\n}\n","import { GeoJSON } from 'geojson';\n\nexport type GeoJSONTypeSet = Set<GeoJSON['type']>;\n\nexport const GEOJSON_FEATURE_TYPE = new Set<GeoJSON['type']>(['Feature']);\n\nexport const GEOJSON_GEOMETRY_TYPES = new Set<GeoJSON['type']>([\n  'Point',\n  'MultiPoint',\n  'Polygon',\n  'MultiPolygon',\n  'LineString',\n  'MultiLineString',\n  'GeometryCollection',\n]);\n\nexport const GEOJSON_GEOMETRY_TYPES_EX_GEOMETRY_COLLECTION = new Set<\n  GeoJSON['type']\n>([\n  'Point',\n  'MultiPoint',\n  'Polygon',\n  'MultiPolygon',\n  'LineString',\n  'MultiLineString',\n]);\n\nexport const GEOJSON_TYPES = new Set<GeoJSON['type']>([\n  ...GEOJSON_GEOMETRY_TYPES,\n  'Feature',\n  'FeatureCollection',\n]);\n","import { GeoJSONTypeSet } from './types';\nimport { GeoJSON } from 'geojson';\nimport { HintIssue, HintError, makeIssue } from './errors';\nimport { Node } from '@humanwhocodes/momoa';\n\nexport function getType(\n  issues: HintIssue[],\n  node: Node,\n  allowedTypes: GeoJSONTypeSet\n) {\n  if (node.type !== 'Object') {\n    throw new HintError([\n      makeIssue('Expected an object, but found an incorrect type.', node),\n    ]);\n  }\n\n  const typeMember = node.members.find(member => {\n    return member.name.value === 'type';\n  });\n\n  if (!typeMember) {\n    issues.push(\n      makeIssue('This GeoJSON object is missing its type member.', node)\n    );\n    return {};\n  }\n\n  const value = typeMember.value;\n\n  if (value.type !== 'String') {\n    issues.push(makeIssue('The type member should have been a string.', node));\n\n    return {};\n  }\n\n  if (!allowedTypes.has(value.value as any)) {\n    issues.push(\n      makeIssue('This type of GeoJSON object is not allowed here.', node)\n    );\n\n    return {};\n  }\n\n  return {\n    type: value.value as GeoJSON['type'],\n    objectNode: node,\n  };\n}\n","import { HintIssue, makeIssue } from './errors';\nimport { ObjectNode } from '@humanwhocodes/momoa';\n\nexport function getMemberValue(\n  issues: HintIssue[],\n  node: ObjectNode,\n  name: string\n) {\n  const member = node.members.find(member => {\n    return member.name.value === name;\n  });\n\n  if (!member) {\n    issues.push(\n      makeIssue(\n        `This GeoJSON object requires a ${name} member but it is missing.`,\n        node\n      )\n    );\n\n    return null;\n  }\n\n  return member.value;\n}\n","import { HintIssue, makeIssue } from './errors';\nimport { Node, ArrayNode } from '@humanwhocodes/momoa';\n\nexport function getArray(\n  issues: HintIssue[],\n  node: Node | null\n): ArrayNode | null {\n  if (node?.type === 'Array') return node;\n  if (node) {\n    issues.push(makeIssue('This must be an array.', node));\n  }\n  return null;\n}\n","import { HintIssue, makeIssue } from './errors';\nimport { Node, ObjectNode } from '@humanwhocodes/momoa';\n\nexport function getObject(\n  issues: HintIssue[],\n  node: Node | null\n): ObjectNode | null {\n  if (node?.type === 'Object') return node;\n  if (node) {\n    issues.push(makeIssue('This must be an object.', node));\n  }\n  return null;\n}\n","import { HintIssue } from './errors';\nimport { ObjectNode } from '@humanwhocodes/momoa';\nimport { getMemberValue } from './get_member_value';\nimport { getArray } from './get_array';\n\nexport function getCoordinates(issues: HintIssue[], node: ObjectNode) {\n  const coordinatesMember = getMemberValue(issues, node, 'coordinates');\n  if (!coordinatesMember) return null;\n  return getArray(issues, coordinatesMember);\n}\n","import { Node } from '@humanwhocodes/momoa';\nimport { HintIssue, makeIssue } from './errors';\n\nexport function arrayIsNumbers(\n  issues: HintIssue[],\n  elements: Node[],\n  name: string\n) {\n  for (let element of elements) {\n    if (element.type !== 'Number') {\n      issues.push(\n        makeIssue(`Each element in a ${name} must be a number.`, element)\n      );\n      return;\n    }\n  }\n}\n","import { HintIssue, makeIssue } from './errors';\nimport { ArrayNode } from '@humanwhocodes/momoa';\nimport { arrayIsNumbers } from './array_is_numbers';\n\nexport function enforcePosition(issues: HintIssue[], node: ArrayNode | null) {\n  // This error has already been caught. Allow a no-op for simplicity.\n  if (node === null) return;\n\n  if (node.elements.length < 2 || node.elements.length > 3) {\n    issues.push(\n      makeIssue(\n        `A position should have 2 or 3 elements - found ${node.elements.length}.`,\n        node\n      )\n    );\n  }\n\n  arrayIsNumbers(issues, node.elements, 'position');\n}\n","import { HintIssue, makeIssue } from './errors';\nimport { ObjectNode } from '@humanwhocodes/momoa';\n\nexport function checkDuplicateKeys(\n  issues: HintIssue[],\n  parent: ObjectNode\n): ObjectNode {\n  let keys = new Set<string>();\n  for (let node of parent.members) {\n    const {\n      name: { value },\n    } = node;\n    if (keys.has(value)) {\n      issues.push(\n        makeIssue('Duplicate properties are ambiguous in GeoJSON', node)\n      );\n    }\n    keys.add(value);\n  }\n  return parent;\n}\n","import { HintIssue, makeIssue } from './errors';\nimport { ArrayNode, NumberNode } from '@humanwhocodes/momoa';\n\nexport function enforceSamePosition(issues: HintIssue[], node: ArrayNode) {\n  const first = node.elements[0] as ArrayNode;\n  const last = node.elements[node.elements.length - 1] as ArrayNode;\n  const len = Math.max(first.elements.length, last.elements.length);\n\n  for (let j = 0; j < len; j++) {\n    const firstValue = (first.elements[j] as NumberNode | undefined)?.value;\n    const secondValue = (last.elements[j] as NumberNode | undefined)?.value;\n    if (firstValue !== secondValue) {\n      issues.push(\n        makeIssue(\n          'First and last positions of a Polygon or MultiPolygon’s ring should be the same.',\n          first\n        ),\n        makeIssue(\n          'First and last positions of a Polygon or MultiPolygon’s ring should be the same.',\n          last\n        )\n      );\n      return;\n    }\n  }\n}\n","import { HintIssue, makeIssue } from './errors';\nimport { enforcePosition } from './enforce_position';\nimport { enforceSamePosition } from './enforce_same_position';\nimport { Node, ArrayNode } from '@humanwhocodes/momoa';\n\nfunction getArray(issues: HintIssue[], node: Node): ArrayNode | null {\n  if (node.type !== 'Array') {\n    issues.push(\n      makeIssue('Expected to find an array of positions here.', node)\n    );\n    return null;\n  }\n  return node;\n}\n\ntype PositionKind = 'Polygon' | 'LineString';\n\nexport function enforcePositionArray(\n  issues: HintIssue[],\n  node: Node | null,\n  kind?: PositionKind\n) {\n  // This error has already been caught. Allow a no-op for simplicity.\n  if (node === null) return;\n\n  node = getArray(issues, node);\n  if (!node) return;\n\n  for (let element of node.elements) {\n    if (element.type !== 'Array') {\n      issues.push(\n        makeIssue(\n          'Expected to find a position here, found another type.',\n          element\n        )\n      );\n      return;\n    } else {\n      enforcePosition(issues, element);\n    }\n  }\n\n  switch (kind) {\n    case 'LineString': {\n      if (node.elements.length < 2) {\n        issues.push(\n          makeIssue('Expected to find two or more positions here.', node)\n        );\n      }\n      break;\n    }\n    case 'Polygon':\n      if (node.elements.length < 4) {\n        issues.push(\n          makeIssue('Expected to find four or more positions here.', node)\n        );\n      }\n      enforceSamePosition(issues, node);\n      break;\n  }\n}\n\nexport function enforcePositionArray2(\n  issues: HintIssue[],\n  node: Node | null,\n  kind?: PositionKind\n) {\n  // This error has already been caught. Allow a no-op for simplicity.\n  if (node === null) return;\n\n  node = getArray(issues, node);\n  if (!node) return;\n\n  for (let element of node.elements) {\n    enforcePositionArray(issues, element, kind);\n  }\n}\n\nexport function enforcePositionArray3(\n  issues: HintIssue[],\n  node: ArrayNode | null,\n  kind?: PositionKind\n) {\n  // This error has already been caught. Allow a no-op for simplicity.\n  if (node === null) return;\n\n  node = getArray(issues, node);\n  if (!node) return;\n\n  for (let element of node.elements) {\n    enforcePositionArray2(issues, element, kind);\n  }\n}\n","import { HintIssue, makeIssue } from './errors';\nimport { ObjectNode } from '@humanwhocodes/momoa';\nimport { getArray } from './get_array';\nimport { arrayIsNumbers } from './array_is_numbers';\n\nexport function enforceBbox(issues: HintIssue[], node: ObjectNode) {\n  const member = node.members.find(member => {\n    return member.name.value === 'bbox';\n  });\n\n  // bboxes are optional\n  if (member === undefined) return;\n\n  const array = getArray(issues, member.value);\n\n  if (!array) return;\n\n  if (!(array.elements.length === 4 || array.elements.length === 6)) {\n    issues.push(makeIssue('A bbox must have 4 or 6 positions', array));\n  }\n\n  arrayIsNumbers(issues, array.elements, 'bbox');\n}\n","import { HintIssue, makeIssue } from './errors';\nimport { ObjectNode, MemberNode } from '@humanwhocodes/momoa';\n\ntype PropertiesFrom = 'Feature' | 'FeatureCollection' | 'Geometry';\n\nfunction forbidProperty(\n  issues: HintIssue[],\n  member: MemberNode,\n  propertiesFrom: PropertiesFrom,\n  name: string\n) {\n  if (member.name.value === name) {\n    issues.push(\n      makeIssue(\n        `${propertiesFrom} objects cannot contain a member named ${member.name.value}`,\n        member.name\n      )\n    );\n  }\n}\n\nconst FORBIDDEN_PROPERTIES = {\n  Geometry: ['properties', 'geometry', 'features'],\n  Feature: ['features'],\n  FeatureCollection: ['properties', 'coordinates'],\n};\n\nexport function forbidConfusingProperties(\n  issues: HintIssue[],\n  node: ObjectNode,\n  propertiesFrom: PropertiesFrom\n) {\n  for (let member of node.members) {\n    for (let property of FORBIDDEN_PROPERTIES[propertiesFrom]) {\n      forbidProperty(issues, member, propertiesFrom, property);\n    }\n  }\n}\n","import {\n  parse,\n  evaluate,\n  DocumentNode,\n  Node,\n  ObjectNode,\n} from '@humanwhocodes/momoa';\nimport { GeoJSON } from 'geojson';\nimport { HintIssue, HintError, makeIssue } from './errors';\nimport {\n  GeoJSONTypeSet,\n  GEOJSON_TYPES,\n  GEOJSON_GEOMETRY_TYPES,\n  GEOJSON_GEOMETRY_TYPES_EX_GEOMETRY_COLLECTION,\n  GEOJSON_FEATURE_TYPE,\n} from './types';\nimport { getType } from './get_type';\nimport { getMemberValue } from './get_member_value';\nimport { getArray } from './get_array';\nimport { getObject } from './get_object';\nimport { getCoordinates } from './get_coordinates';\nimport { enforcePosition } from './enforce_position';\nimport { checkDuplicateKeys } from './check_duplicate_keys';\nimport {\n  enforcePositionArray,\n  enforcePositionArray2,\n  enforcePositionArray3,\n} from './enforce_position_array';\nimport { enforceBbox } from './enforce_bbox';\nimport { forbidConfusingProperties } from './forbid_confusing_properties';\n\ntype Checker = (issues: HintIssue[], node: ObjectNode) => void;\n\nconst checkGeometryShared: Checker = (issues, node) => {\n  enforceBbox(issues, node);\n  forbidConfusingProperties(issues, node, 'Geometry');\n};\n\nconst checkLineString: Checker = (issues, node) => {\n  enforcePositionArray(issues, getCoordinates(issues, node), 'LineString');\n  checkGeometryShared(issues, node);\n};\n\nconst checkMultiLineString: Checker = (issues, node) => {\n  enforcePositionArray2(issues, getCoordinates(issues, node), 'LineString');\n  checkGeometryShared(issues, node);\n};\n\nconst checkPolygon: Checker = (issues, node) => {\n  enforcePositionArray2(issues, getCoordinates(issues, node), 'Polygon');\n  checkGeometryShared(issues, node);\n};\n\nconst checkMultiPolygon: Checker = (issues, node) => {\n  enforcePositionArray3(issues, getCoordinates(issues, node), 'Polygon');\n  checkGeometryShared(issues, node);\n};\n\nconst checkPoint: Checker = (issues, node) => {\n  enforcePosition(issues, getCoordinates(issues, node));\n  checkGeometryShared(issues, node);\n};\n\nconst checkMultiPoint: Checker = (issues, node) => {\n  enforcePositionArray(issues, getCoordinates(issues, node));\n  checkGeometryShared(issues, node);\n};\n\nconst checkGeometryCollection: Checker = (issues, node) => {\n  checkGeometryShared(issues, node);\n  const geometriesMember = getArray(\n    issues,\n    getMemberValue(issues, node, 'geometries')\n  );\n  if (!geometriesMember) return;\n  for (let element of geometriesMember.elements) {\n    checkObject(issues, element, GEOJSON_GEOMETRY_TYPES_EX_GEOMETRY_COLLECTION);\n  }\n};\n\nconst checkFeature: Checker = (issues, node) => {\n  forbidConfusingProperties(issues, node, 'Feature');\n  const geometryMember = getMemberValue(issues, node, 'geometry');\n  enforceBbox(issues, node);\n  if (geometryMember?.type !== 'Null') {\n    const geometry = getObject(issues, geometryMember);\n    if (geometry) checkObject(issues, geometry, GEOJSON_GEOMETRY_TYPES);\n  }\n\n  const idMember = node.members.find(member => {\n    return member.name.value === 'id';\n  });\n  if (\n    idMember &&\n    !(idMember.value.type === 'String' || idMember.value.type === 'Number')\n  ) {\n    issues.push(makeIssue(`The Feature id must be a string or number.`, node));\n  }\n\n  const properties = getMemberValue(issues, node, 'properties');\n  if (!properties) {\n    issues.push(makeIssue(`The properties member is missing.`, node));\n    return;\n  }\n\n  const { type } = properties;\n\n  if (!(type === 'Object' || type === 'Null')) {\n    issues.push(\n      makeIssue(`The Feature properties member can be an object or null.`, node)\n    );\n  }\n};\n\nconst checkFeatureCollection: Checker = (issues, node) => {\n  forbidConfusingProperties(issues, node, 'FeatureCollection');\n  const featuresMember = getArray(\n    issues,\n    getMemberValue(issues, node, 'features')\n  );\n  if (!featuresMember) return;\n  for (let feature of featuresMember.elements) {\n    const obj = getObject(issues, feature);\n    if (obj) {\n      getType(issues, obj, GEOJSON_FEATURE_TYPE);\n      checkFeature(issues, obj);\n    }\n  }\n};\n\nconst CHECKERS: Record<GeoJSON['type'], Checker> = {\n  LineString: checkLineString,\n  MultiLineString: checkMultiLineString,\n\n  Polygon: checkPolygon,\n  MultiPolygon: checkMultiPolygon,\n\n  Point: checkPoint,\n  MultiPoint: checkMultiPoint,\n\n  GeometryCollection: checkGeometryCollection,\n\n  Feature: checkFeature,\n  FeatureCollection: checkFeatureCollection,\n};\n\nfunction checkObject(\n  issues: HintIssue[],\n  node: Node,\n  typeSet: GeoJSONTypeSet = GEOJSON_TYPES\n) {\n  const { type, objectNode } = getType(issues, node, typeSet);\n  if (!(type && objectNode)) return;\n  checkDuplicateKeys(issues, objectNode);\n  CHECKERS[type](issues, objectNode);\n}\n\nfunction checkInternal(\n  jsonStr: string\n): {\n  ast: DocumentNode | undefined;\n  issues: HintIssue[];\n} {\n  const issues: HintIssue[] = [];\n  let ast;\n  try {\n    ast = parse(jsonStr, {\n      ranges: true,\n    });\n    checkObject(issues, ast.body);\n  } catch (e) {\n    issues.push({\n      message: `Invalid JSON: ${e.message}`,\n      from: 0,\n      to: 0,\n      severity: 'error',\n    });\n  }\n\n  return { ast, issues };\n}\n\nexport const getIssues = (jsonStr: string): HintIssue[] => {\n  return checkInternal(jsonStr).issues;\n};\n\nexport const check = (jsonStr: string): GeoJSON => {\n  const { issues, ast } = checkInternal(jsonStr);\n  if (issues.length || !ast) throw new HintError(issues);\n  return evaluate(ast);\n};\n\nexport { HintError, HintIssue };\n"],"names":["makeIssue","message","node","severity","from","loc","start","offset","to","end","HintError","Error","constructor","issues","actualProto","new","target","prototype","Object","setPrototypeOf","JSON","stringify","GEOJSON_FEATURE_TYPE","Set","GEOJSON_GEOMETRY_TYPES","GEOJSON_GEOMETRY_TYPES_EX_GEOMETRY_COLLECTION","GEOJSON_TYPES","getType","allowedTypes","type","typeMember","members","find","member","name","value","push","has","objectNode","getMemberValue","getArray","getObject","getCoordinates","coordinatesMember","arrayIsNumbers","elements","element","enforcePosition","length","checkDuplicateKeys","parent","keys","add","enforceSamePosition","first","last","len","Math","max","j","firstValue","secondValue","enforcePositionArray","kind","enforcePositionArray2","enforcePositionArray3","enforceBbox","undefined","array","forbidProperty","propertiesFrom","FORBIDDEN_PROPERTIES","Geometry","Feature","FeatureCollection","forbidConfusingProperties","property","checkGeometryShared","checkLineString","checkMultiLineString","checkPolygon","checkMultiPolygon","checkPoint","checkMultiPoint","checkGeometryCollection","geometriesMember","checkObject","checkFeature","geometryMember","geometry","idMember","properties","checkFeatureCollection","featuresMember","feature","obj","CHECKERS","LineString","MultiLineString","Polygon","MultiPolygon","Point","MultiPoint","GeometryCollection","typeSet","checkInternal","jsonStr","ast","parse","ranges","body","e","getIssues","check","evaluate"],"mappings":"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"}